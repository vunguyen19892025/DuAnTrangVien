<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Tiến Độ Thi Công Dự Án Trang Viên - Dầu Tiếng</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
            align-items: flex-end;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
        }
        
        .input-label {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .input-field {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            background-color: white;
        }
        
        .btn {
            padding: 9px 16px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4338ca;
        }
        
        .btn-secondary {
            background-color: #64748b;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #475569;
        }
        
        .section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e293b;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .gantt-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .zoom-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            background-color: white;
            font-size: 1.25rem;
            cursor: pointer;
        }
        
        .zoom-btn:hover {
            background-color: #f1f5f9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f8fafc;
            font-weight: 500;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .log-container {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
            font-size: 0.875rem;
        }
        
        .log-entry.error {
            color: #dc2626;
        }
        
        .log-entry.warning {
            color: #d97706;
        }
        
        .log-entry.info {
            color: #2563eb;
        }
        
        .hidden {
            display: none;
        }
        
        /* Custom styling for payment phases */
        .payment-phase {
            font-weight: 500;
            color: #1e40af;
        }
        
        /* Task color coding */
        .task-preparation {
            background-color: #93c5fd;
        }
        
        .task-foundation {
            background-color: #86efac;
        }
        
        .task-main-building {
            background-color: #fdba74;
        }
        
        .task-secondary {
            background-color: #c4b5fd;
        }
        
        .task-landscape {
            background-color: #67e8f9;
        }
        
        .task-finishing {
            background-color: #f9a8d4;
        }
        
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-container {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-3xl font-bold mb-2">Bảng Tiến Độ Thi Công Dự Án Trang Viên - Dầu Tiếng</h1>
            <p class="text-gray-600">Đơn vị thi công: CÔNG TY TNHH NÉT VIỆT</p>
        </div>
        
        <div class="section">
            <h2 class="section-title">Thông tin dự án</h2>
            <div class="input-group">
                <div class="input-container">
                    <label class="input-label">Chủ đầu tư:</label>
                    <div class="input-field bg-gray-100">ANH HƯNG</div>
                </div>
                <div class="input-container">
                    <label class="input-label">Địa điểm:</label>
                    <div class="input-field bg-gray-100">DẦU TIẾNG</div>
                </div>
                <div class="input-container">
                    <label class="input-label">Giá trị hợp đồng (VNĐ):</label>
                    <input type="text" id="contractValue" class="input-field" value="16325600000">
                </div>
                <div class="input-container">
                    <label class="input-label">Ngày bắt đầu thi công:</label>
                    <input type="date" id="startDate" class="input-field" value="2025-05-05">
                </div>
                <div class="input-container">
                    <label class="input-label">Tổng thời gian thi công (ngày):</label>
                    <input type="number" id="totalDuration" class="input-field" value="250" min="100" max="500">
                </div>
                <button id="updateBtn" class="btn btn-primary">Cập nhật</button>
            </div>
            <div id="prepInfo" class="text-sm text-gray-600 mt-3">
                Giai đoạn chuẩn bị bắt đầu từ <span id="prepStartDate">15/04/2025</span> (20 ngày trước khi thi công chính thức)
            </div>
            <div id="logContainer" class="log-container hidden">
                <!-- Log entries will be added here -->
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Biểu đồ Gantt tiến độ thi công</h2>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOut">-</button>
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomFit">⟳</button>
            </div>
            <div class="color-legend">
                <div class="legend-item">
                    <div class="legend-color task-preparation"></div>
                    <span>Giai đoạn chuẩn bị</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-foundation"></div>
                    <span>Gia cố nền & Móng</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-main-building"></div>
                    <span>Công trình nhà chính</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-secondary"></div>
                    <span>Công trình phụ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-landscape"></div>
                    <span>Sân vườn & Hạ tầng</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-finishing"></div>
                    <span>Hoàn thiện</span>
                </div>
            </div>
            <div id="ganttChart" class="gantt-container"></div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Bảng chi tiết tiến độ thi công</h2>
            <div class="table-container">
                <table id="scheduleTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Hạng mục công việc</th>
                            <th>Thời gian bắt đầu</th>
                            <th>Thời gian hoàn thành</th>
                            <th>Số ngày</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Schedule data will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Bảng đợt thanh toán</h2>
            <div class="table-container">
                <table id="paymentTable">
                    <thead>
                        <tr>
                            <th>Đợt</th>
                            <th>Giai đoạn</th>
                            <th>Tỷ lệ</th>
                            <th>Giá trị (VNĐ)</th>
                            <th>Thời gian dự kiến</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Payment data will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Use Luxon for date handling
        const DateTime = luxon.DateTime;
        
        // Initial data
        const DEFAULT_START_DATE = "2025-05-05";
        const DEFAULT_TOTAL_DURATION = 250;
        const DEFAULT_CONTRACT_VALUE = 12888800000;
        const PREP_DURATION = 20; // days before main construction
        
        // Task categories with default durations (percentages of total duration)
        const taskCategories = [
            { name: "Giai đoạn chuẩn bị", duration: PREP_DURATION, fixed: true, category: "preparation" },
            { name: "Thi công gia cố nền đất yếu & móng", duration: 0.16, category: "foundation" }, // 16% of total duration
            { name: "Thi công phần móng nhà từ đường & nâng đế", duration: 0.2, category: "foundation" }, // 20% of total duration
            { name: "Thi công móng công trình phụ", duration: 0.12, category: "foundation" }, // 12% of total duration
            { name: "Thi công tường rào & nâng nền", duration: 0.12, category: "main-building" }, // 12% of total duration
            { name: "Thi công nhà từ đường (nhà chính)", duration: 0.28, category: "main-building" }, // 28% of total duration
            { name: "Thi công cổng tam quan", duration: 0.16, category: "main-building" }, // 16% of total duration
            { name: "Thi công công trình phụ", duration: 0.24, category: "secondary" }, // 24% of total duration
            { name: "Thi công hạ tầng tổng thể", duration: 0.12, category: "landscape" }, // 12% of total duration
            { name: "Hoàn thiện nhà từ đường", duration: 0.24, category: "finishing" }, // 24% of total duration
            { name: "Thi công nội thất", duration: 0.12, category: "finishing" }, // 12% of total duration
            { name: "Hoàn thiện cảnh quan", duration: 0.18, category: "landscape" }, // 18% of total duration
            { name: "Hoàn thiện và bàn giao", duration: 0.08, category: "finishing" }, // 8% of total duration
        ];
        
        // Detailed tasks (subtasks)
        const detailedTasks = [
            { parent: 0, name: "Trắc đạc, định vị công trình", duration: 0.25, startOffset: 0 },
            { parent: 0, name: "Tổ chức công trường, làm lán trại", duration: 0.4, startOffset: 0 },
            { parent: 0, name: "Phá dỡ công trình hiện trạng", duration: 0.5, startOffset: 0.25 },
            { parent: 0, name: "Xây tường rào bảo vệ công trình", duration: 0.5, startOffset: 0.5 },
            
            { parent: 1, name: "Đào đắp đất tổng thể", duration: 0.375, startOffset: 0 },
            { parent: 1, name: "Ép cọc BTCT 250x250", duration: 0.375, startOffset: 0.375 },
            { parent: 1, name: "Khoan giếng ngầm", duration: 0.125, startOffset: 0.75 },
            { parent: 1, name: "Đào hố thấm tự nhiên", duration: 0.125, startOffset: 0.875 },
            
            { parent: 2, name: "Thi công phần móng nhà từ đường", duration: 0.6, startOffset: 0 },
            { parent: 2, name: "Thi công nâng cao khối đế lên 0.8m", duration: 0.4, startOffset: 0.6 },
            
            { parent: 3, name: "Móng cổng tam quan", duration: 0.33, startOffset: 0 },
            { parent: 3, name: "Móng chòi vọng cảnh", duration: 0.33, startOffset: 0.33 },
            { parent: 3, name: "Đào hồ Koi và xử lý nền", duration: 0.34, startOffset: 0.66 },
            
            { parent: 4, name: "Xây tường bó để nâng nền toàn khối", duration: 0.33, startOffset: 0 },
            { parent: 4, name: "Thi công tường rào thường", duration: 0.5, startOffset: 0.33 },
            { parent: 4, name: "Thi công tường rào có hoa văn phù điêu", duration: 0.17, startOffset: 0.83 },
            
            { parent: 5, name: "Thi công tầng trệt nhà chính", duration: 0.43, startOffset: 0 },
            { parent: 5, name: "Thi công mái công trình", duration: 0.43, startOffset: 0.43 },
            { parent: 5, name: "Thi công phù điêu đỉnh, diềm mái", duration: 0.21, startOffset: 0.79 },
            { parent: 5, name: "Lắp đặt cuốn thư đá", duration: 0.14, startOffset: 0.86 },
            
            { parent: 6, name: "Thi công phần thân cổng", duration: 0.375, startOffset: 0 },
            { parent: 6, name: "Thi công phần mái cổng", duration: 0.375, startOffset: 0.375 },
            { parent: 6, name: "Lắp đặt bộ cửa cổng chính và phụ", duration: 0.25, startOffset: 0.75 },
            
            { parent: 7, name: "Thi công thân và mái nhà chòi vọng cảnh", duration: 0.5, startOffset: 0 },
            { parent: 7, name: "Thi công hồ Koi", duration: 0.67, startOffset: 0 },
            { parent: 7, name: "Thi công khu nghĩa trang", duration: 0.5, startOffset: 0.17 },
            { parent: 7, name: "Xây nhà kho và bồn nước", duration: 0.33, startOffset: 0.67 },
            
            { parent: 8, name: "Thi công bê tông nền cảnh quan và đường dạo", duration: 0.5, startOffset: 0 },
            { parent: 8, name: "Xây bó vỉa và hoàn thiện nền đá", duration: 0.33, startOffset: 0.5 },
            { parent: 8, name: "Lắp đặt hệ thống thoát nước và tưới tự động", duration: 0.5, startOffset: 0.5 },
            
            { parent: 9, name: "Thi công ốp lát gạch", duration: 0.33, startOffset: 0 },
            { parent: 9, name: "Thi công ốp đá và lan can", duration: 0.5, startOffset: 0 },
            { parent: 9, name: "Lắp đặt hệ thống điện và nước âm tường", duration: 0.33, startOffset: 0 },
            { parent: 9, name: "Lắp đặt cửa gỗ", duration: 0.25, startOffset: 0.33 },
            { parent: 9, name: "Sơn nước trong và ngoài nhà", duration: 0.33, startOffset: 0.33 },
            { parent: 9, name: "Lắp đặt thiết bị vệ sinh", duration: 0.17, startOffset: 0.58 },
            { parent: 9, name: "Lắp đặt thiết bị điện và chiếu sáng", duration: 0.25, startOffset: 0.58 },
            { parent: 9, name: "Xử lý phòng chống mối", duration: 0.08, startOffset: 0.75 },
            
            { parent: 10, name: "Thi công trần trang trí hoa văn", duration: 0.33, startOffset: 0 },
            { parent: 10, name: "Lắp đặt vách ốp tường sau bàn thờ", duration: 0.33, startOffset: 0 },
            { parent: 10, name: "Lắp đặt bàn thờ và nội thất phòng thờ", duration: 0.33, startOffset: 0.33 },
            { parent: 10, name: "Lắp đặt tủ bếp và nội thất phòng bếp", duration: 0.33, startOffset: 0.33 },
            { parent: 10, name: "Lắp đặt nội thất phòng ngủ", duration: 0.34, startOffset: 0.66 },
            
            { parent: 11, name: "Thi công tiểu cảnh non bộ", duration: 0.33, startOffset: 0 },
            { parent: 11, name: "Thi công cầu vượt hồ koi", duration: 0.22, startOffset: 0.33 },
            { parent: 11, name: "Trồng thảm cỏ nhung Nhật", duration: 0.22, startOffset: 0.55 },
            { parent: 11, name: "Lắp đặt hệ thống đèn sân vườn", duration: 0.33, startOffset: 0.55 },
            { parent: 11, name: "Hoàn thiện trồng cây tiểu cảnh", duration: 0.22, startOffset: 0.78 },
            
            { parent: 12, name: "Hoàn thiện nhà chòi vọng cảnh", duration: 0.25, startOffset: 0 },
            { parent: 12, name: "Vệ sinh công nghiệp toàn công trình", duration: 0.5, startOffset: 0.25 },
            { parent: 12, name: "Nghiệm thu và bàn giao", duration: 0.25, startOffset: 0.75 },
        ];
        
        // Payment phases
        const paymentPhases = [
            { phase: "Ký hợp đồng", percentage: 50, milestone: "start" },
            { phase: "Hoàn thành mái ngói (cất nóc)", percentage: 25, milestone: "roof" },
            { phase: "Xây tô đạt 80%", percentage: 10, milestone: "masonry" },
            { phase: "Bả bột 2 lớp đạt 80%, hoàn thiện ốp lát", percentage: 5, milestone: "finishing" },
            { phase: "Lắp đặt đồ gỗ nội thất", percentage: 4, milestone: "furniture" },
            { phase: "Nghiệm thu + bàn giao", percentage: 3, milestone: "completion" },
            { phase: "Bảo hành, sau 01 năm", percentage: 3, milestone: "warranty" }
        ];
        
        // Get DOM elements
        const contractValueInput = document.getElementById('contractValue');
        const startDateInput = document.getElementById('startDate');
        const totalDurationInput = document.getElementById('totalDuration');
        const updateBtn = document.getElementById('updateBtn');
        const prepStartDateElem = document.getElementById('prepStartDate');
        const logContainer = document.getElementById('logContainer');
        const ganttChartElem = document.getElementById('ganttChart');
        const scheduleTableBody = document.getElementById('scheduleTable').querySelector('tbody');
        const paymentTableBody = document.getElementById('paymentTable').querySelector('tbody');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const zoomFitBtn = document.getElementById('zoomFit');
        
        // Variables to store current data
        let currentStartDate;
        let currentTotalDuration;
        let currentContractValue;
        let currentPrepStartDate;
        let currentTasks = [];
        let currentSubtasks = [];
        let currentPayments = [];
        let zoomLevel = 1;
        let ganttChart;
        
        // Initialize data and charts
        function init() {
            // Set initial values
            currentStartDate = startDateInput.value;
            currentTotalDuration = parseInt(totalDurationInput.value);
            currentContractValue = parseFloat(contractValueInput.value);
            
            // Calculate preparation start date
            calcPrepStartDate();
            
            // Calculate all dates and durations
            calculateSchedule();
            
            // Calculate payment values and dates
            calculatePayments();
            
            // Render the schedule table
            renderScheduleTable();
            
            // Render the payment table
            renderPaymentTable();
            
            // Initialize Gantt chart
            initGanttChart();
        }
        
        // Calculate the preparation start date
        function calcPrepStartDate() {
            let startDate = DateTime.fromISO(currentStartDate);
            currentPrepStartDate = startDate.minus({ days: PREP_DURATION }).toFormat('dd/MM/yyyy');
            prepStartDateElem.textContent = currentPrepStartDate;
        }
        
        // Calculate all task dates and durations
        function calculateSchedule() {
            currentTasks = [];
            currentSubtasks = [];
            
            let startDate = DateTime.fromISO(currentStartDate);
            let prepStartDate = startDate.minus({ days: PREP_DURATION });
            
            // Calculate main tasks
            let currentDate = prepStartDate;
            for (let i = 0; i < taskCategories.length; i++) {
                let task = { ...taskCategories[i] };
                
                // Starting from the second task (after preparation)
                if (i > 0) {
                    // Calculate duration in days (percentage of total duration)
                    task.durationDays = Math.round(task.duration * currentTotalDuration);
                } else {
                    // Fixed duration for preparation
                    task.durationDays = task.duration;
                }
                
                task.startDate = currentDate.toFormat('dd/MM/yyyy');
                
                // Calculate end date
                currentDate = currentDate.plus({ days: task.durationDays });
                task.endDate = currentDate.minus({ days: 1 }).toFormat('dd/MM/yyyy');
                
                // For tasks running in parallel, adjust current date
                if (i > 0) {
                    // For tasks that can overlap with previous tasks
                    if (i === 3 || i === 7 || i === 8 || i === 10 || i === 11) {
                        // Adjust currentDate to be the end date of task i-2
                        currentDate = DateTime.fromFormat(currentTasks[i-2].endDate, 'dd/MM/yyyy').plus({ days: 1 });
                    }
                }
                
                currentTasks.push(task);
            }
            
            // Calculate subtasks
            for (let i = 0; i < detailedTasks.length; i++) {
                let subtask = { ...detailedTasks[i] };
                let parentTask = currentTasks[subtask.parent];
                
                // Get parent task start date
                let parentStartDate = DateTime.fromFormat(parentTask.startDate, 'dd/MM/yyyy');
                
                // Calculate subtask duration
                subtask.durationDays = Math.round(subtask.duration * parentTask.durationDays);
                
                // Calculate start offset in days
                let startOffsetDays = Math.round(subtask.startOffset * parentTask.durationDays);
                
                // Calculate start date
                subtask.startDate = parentStartDate.plus({ days: startOffsetDays }).toFormat('dd/MM/yyyy');
                
                // Calculate end date
                subtask.endDate = parentStartDate.plus({ days: startOffsetDays + subtask.durationDays - 1 }).toFormat('dd/MM/yyyy');
                
                subtask.category = parentTask.category;
                currentSubtasks.push(subtask);
            }
        }
        
        // Calculate payment values and dates
        function calculatePayments() {
            currentPayments = [];
            
            // First payment is on the start date
            let firstPayment = {
                ...paymentPhases[0],
                amount: currentContractValue * (paymentPhases[0].percentage / 100),
                date: DateTime.fromISO(currentStartDate).toFormat('dd/MM/yyyy')
            };
            currentPayments.push(firstPayment);
            
            // Calculate other payments
            for (let i = 1; i < paymentPhases.length; i++) {
                let payment = { ...paymentPhases[i] };
                payment.amount = currentContractValue * (payment.percentage / 100);
                
                // Calculate payment date based on milestone
                switch (payment.milestone) {
                    case 'roof':
                        // After completing roof construction (end of task 5 - Thi công mái công trình)
                        payment.date = DateTime.fromFormat(currentSubtasks.find(st => st.parent === 5 && st.name === "Thi công mái công trình").endDate, 'dd/MM/yyyy').toFormat('dd/MM/yyyy');
                        break;
                    case 'masonry':
                        // After 80% of masonry (halfway through task 9 - Hoàn thiện nhà từ đường)
                        payment.date = DateTime.fromFormat(currentTasks[9].startDate, 'dd/MM/yyyy').plus({ days: Math.round(currentTasks[9].durationDays * 0.5) }).toFormat('dd/MM/yyyy');
                        break;
                    case 'finishing':
                        // After 80% finishing and tiling (end of task 9 - Hoàn thiện nhà từ đường)
                        payment.date = DateTime.fromFormat(currentTasks[9].endDate, 'dd/MM/yyyy').toFormat('dd/MM/yyyy');
                        break;
                    case 'furniture':
                        // After furniture installation (end of task 10 - Thi công nội thất)
                        payment.date = DateTime.fromFormat(currentTasks[10].endDate, 'dd/MM/yyyy').toFormat('dd/MM/yyyy');
                        break;
                    case 'completion':
                        // After completion (end of task 12 - Hoàn thiện và bàn giao)
                        payment.date = DateTime.fromFormat(currentTasks[12].endDate, 'dd/MM/yyyy').toFormat('dd/MM/yyyy');
                        break;
                    case 'warranty':
                        // One year after completion
                        payment.date = DateTime.fromFormat(currentTasks[12].endDate, 'dd/MM/yyyy').plus({ years: 1 }).toFormat('dd/MM/yyyy');
                        break;
                }
                
                currentPayments.push(payment);
            }
        }
        
        // Render schedule table
        function renderScheduleTable() {
            scheduleTableBody.innerHTML = '';
            
            // Add parent tasks
            for (let i = 0; i < currentTasks.length; i++) {
                const task = currentTasks[i];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td><strong>${task.name}</strong></td>
                    <td>${task.startDate}</td>
                    <td>${task.endDate}</td>
                    <td>${task.durationDays}</td>
                    <td>${i === 0 ? 'Giai đoạn chuẩn bị' : ''}</td>
                `;
                if (i === 0) row.classList.add('task-preparation');
                scheduleTableBody.appendChild(row);
                
                // Add subtasks
                const subtasks = currentSubtasks.filter(st => st.parent === i);
                for (let j = 0; j < subtasks.length; j++) {
                    const subtask = subtasks[j];
                    const subrow = document.createElement('tr');
                    subrow.innerHTML = `
                        <td>${i + 1}.${j + 1}</td>
                        <td>- ${subtask.name}</td>
                        <td>${subtask.startDate}</td>
                        <td>${subtask.endDate}</td>
                        <td>${subtask.durationDays}</td>
                        <td></td>
                    `;
                    
                    // Add class based on category
                    if (subtask.category === 'preparation') subrow.classList.add('task-preparation');
                    else if (subtask.category === 'foundation') subrow.classList.add('task-foundation');
                    else if (subtask.category === 'main-building') subrow.classList.add('task-main-building');
                    else if (subtask.category === 'secondary') subrow.classList.add('task-secondary');
                    else if (subtask.category === 'landscape') subrow.classList.add('task-landscape');
                    else if (subtask.category === 'finishing') subrow.classList.add('task-finishing');
                    
                    scheduleTableBody.appendChild(subrow);
                }
            }
        }
        
        // Render payment table
        function renderPaymentTable() {
            paymentTableBody.innerHTML = '';
            
            for (let i = 0; i < currentPayments.length; i++) {
                const payment = currentPayments[i];
                const row = document.createElement('tr');
                
                // Format the amount with thousand separators
                const formattedAmount = payment.amount.toLocaleString('vi-VN');
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="payment-phase">${payment.phase}</td>
                    <td>${payment.percentage}%</td>
                    <td>${formattedAmount}</td>
                    <td>${payment.date}</td>
                `;
                paymentTableBody.appendChild(row);
            }
        }
        
        // Initialize Gantt chart
        function initGanttChart() {
            const series = [];
            const categories = [];
            
            // Combine tasks and subtasks for the chart
            const allTasks = [...currentTasks];
            
            // Add tasks to the chart
            for (let i = 0; i < allTasks.length; i++) {
                const task = allTasks[i];
                const taskName = task.name;
                
                // Convert date strings to DateTime objects
                const startDate = DateTime.fromFormat(task.startDate, 'dd/MM/yyyy');
                const endDate = DateTime.fromFormat(task.endDate, 'dd/MM/yyyy');
                
                // Get task color based on category
                const fillColor = getCategoryColor(task.category);
                
                series.push({
                    name: taskName,
                    data: [{
                        x: taskName,
                        y: [
                            startDate.toMillis(),
                            endDate.plus({ days: 1 }).toMillis() // Add 1 day to include end date
                        ],
                        fillColor: fillColor
                    }]
                });
                
                categories.push(taskName);
            }
            
            // Add payment milestones
            const payments = [];
            for (let i = 0; i < currentPayments.length; i++) {
                const payment = currentPayments[i];
                const paymentDate = DateTime.fromFormat(payment.date, 'dd/MM/yyyy');
                
                payments.push({
                    x: new Date(paymentDate.toISO()).getTime(),
                    y: 0,
                    marker: {
                        size: 8,
                        fillColor: '#ff0000',
                        strokeColor: '#ffffff',
                        radius: 2
                    },
                    label: {
                        borderColor: '#ff0000',
                        offsetY: -10,
                        text: `Đợt ${i + 1}: ${payment.percentage}%`
                    }
                });
            }
            
            const options = {
                series: series,
                chart: {
                    height: 450,
                    type: 'rangeBar',
                    toolbar: {
                        show: false
                    },
                    fontFamily: 'Roboto, sans-serif'
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '80%',
                        rangeBarGroupRows: true
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeFormatter: {
                            day: 'dd/MM',
                            month: 'MM/yyyy'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                tooltip: {
                    custom: function({ seriesIndex, dataPointIndex, w }) {
                        const task = allTasks[seriesIndex];
                        return `
                            <div class="p-2">
                                <strong>${task.name}</strong><br>
                                Từ: ${task.startDate}<br>
                                Đến: ${task.endDate}<br>
                                Thời gian: ${task.durationDays} ngày
                            </div>
                        `;
                    }
                },
                annotations: {
                    xaxis: currentPayments.map((payment, index) => {
                        const paymentDate = DateTime.fromFormat(payment.date, 'dd/MM/yyyy');
                        return {
                            x: paymentDate.toMillis(),
                            borderColor: '#FF4560',
                            label: {
                                style: {
                                    color: '#fff',
                                    background: '#FF4560'
                                },
                                text: `Đợt ${index + 1}: ${payment.percentage}%`
                            }
                        };
                    })
                },
                grid: {
                    borderColor: '#e0e0e0',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                legend: {
                    show: false
                },
                dataLabels: {
                    enabled: false
                },
                fill: {
                    type: 'solid',
                    opacity: 1
                }
            };
            
            if (ganttChart) {
                ganttChart.destroy();
            }
            
            ganttChart = new ApexCharts(ganttChartElem, options);
            ganttChart.render();
        }
        
        // Get color based on task category
        function getCategoryColor(category) {
            switch (category) {
                case 'preparation': return '#93c5fd'; // blue-300
                case 'foundation': return '#86efac'; // green-300
                case 'main-building': return '#fdba74'; // orange-300
                case 'secondary': return '#c4b5fd'; // violet-300
                case 'landscape': return '#67e8f9'; // cyan-300
                case 'finishing': return '#f9a8d4'; // pink-300
                default: return '#d1d5db'; // gray-300
            }
        }
        
        // Format number with thousand separators
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Event listeners
        updateBtn.addEventListener('click', function() {
            // Validate input
            let isValid = true;
            let messages = [];
            
            // Validate contract value
            const contractValue = parseFloat(contractValueInput.value.replace(/,/g, ''));
            if (isNaN(contractValue) || contractValue <= 0) {
                isValid = false;
                messages.push({ type: 'error', message: 'Giá trị hợp đồng không hợp lệ' });
            }
            
            // Validate start date
            const startDate = startDateInput.value;
            if (!startDate) {
                isValid = false;
                messages.push({ type: 'error', message: 'Ngày bắt đầu không hợp lệ' });
            }
            
            // Validate total duration
            const totalDuration = parseInt(totalDurationInput.value);
            if (isNaN(totalDuration) || totalDuration < 100 || totalDuration > 500) {
                isValid = false;
                messages.push({ type: 'error', message: 'Tổng thời gian thi công phải từ 100 đến 500 ngày' });
            }
            
            // If invalid, show messages and return
            if (!isValid) {
                logContainer.innerHTML = '';
                logContainer.classList.remove('hidden');
                
                messages.forEach(msg => {
                    const logEntry = document.createElement('div');
                    logEntry.classList.add('log-entry', msg.type);
                    logEntry.textContent = msg.message;
                    logContainer.appendChild(logEntry);
                });
                
                return;
            }
            
            // Update current values
            currentStartDate = startDate;
            currentTotalDuration = totalDuration;
            currentContractValue = contractValue;
            
            // Calculate preparation start date
            calcPrepStartDate();
            
            // Calculate schedule
            calculateSchedule();
            
            // Calculate payments
            calculatePayments();
            
            // Render tables and chart
            renderScheduleTable();
            renderPaymentTable();
            initGanttChart();
            
            // Show success message
            logContainer.innerHTML = '';
            logContainer.classList.remove('hidden');
            
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry', 'info');
            logEntry.textContent = 'Cập nhật thành công';
            logContainer.appendChild(logEntry);
            
            // Hide log after 3 seconds
            setTimeout(() => {
                logContainer.classList.add('hidden');
            }, 3000);
        });
        
        // Format contract value with thousand separators
        contractValueInput.addEventListener('input', function(e) {
            // Remove all non-digit characters
            let value = e.target.value.replace(/\D/g, '');
            
            // Format with thousand separators
            if (value) {
                value = parseInt(value).toLocaleString('en-US');
            }
            
            // Update input value
            e.target.value = value;
        });
        
        // Zoom controls
        zoomInBtn.addEventListener('click', function() {
            if (ganttChart) {
                ganttChart.zoomX(0.5, 1.5);
            }
        });
        
        zoomOutBtn.addEventListener('click', function() {
            if (ganttChart) {
                ganttChart.zoomX(1.5, 0.5);
            }
        });
        
        zoomFitBtn.addEventListener('click', function() {
            if (ganttChart) {
                ganttChart.resetSeries();
            }
        });
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
