Copy
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Tiến Độ Thi Công Dự Án Trang Viên - Dầu Tiếng</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            overflow-x: auto;
            min-height: 600px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f1f5f9;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        tr:hover {
            background-color: #e2e8f0;
        }
        .zoom-controls {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        .zoom-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .zoom-btn:hover {
            background-color: #2563eb;
        }
        .payment-milestone {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        .payment-milestone span {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .header-section {
            background-color: #1e3a8a;
            color: white;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .control-panel {
            background-color: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .control-panel label {
            font-weight: bold;
        }
        .btn-update {
            background-color: #10b981;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-update:hover {
            background-color: #059669;
        }
        .progress-label {
            position: absolute;
            right: 10px;
            top: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        @media print {
            body {
                width: 100%;
                margin: 0;
                padding: 0;
                background-color: white;
            }
            .print-container {
                width: 100%;
                padding: 20px;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="print-container">
        <div class="header-section mb-6">
            <h1 class="text-2xl md:text-3xl font-bold mb-2 text-center">BẢNG TIẾN ĐỘ THI CÔNG DỰ ÁN TRANG VIÊN - DẦU TIẾNG</h1>
            <div class="flex flex-col md:flex-row justify-between text-sm md:text-base">
                <div>
                    <p><strong>Chủ đầu tư:</strong> ANH HƯNG</p>
                    <p><strong>Đơn vị thi công:</strong> CÔNG TY TNHH NÉT VIỆT</p>
                </div>
                <div>
                    <p><strong>Địa điểm:</strong> DẦU TIẾNG</p>
                    <p><strong>Tổng giá trị hợp đồng:</strong>...........</p>
                </div>
            </div>
        </div>

        <div class="control-panel no-print">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="startDate" class="block mb-2">Ngày bắt đầu thi công chính thức:</label>
                    <input type="text" id="startDate" class="w-full p-2 border rounded" value="05/05/2025">
                </div>
                <div>
                    <label for="totalDays" class="block mb-2">Tổng thời gian thi công (ngày):</label>
                    <div class="flex">
                        <button id="decreaseDays" class="bg-gray-200 px-4 py-2 rounded-l font-bold text-xl">-</button>
                        <input type="number" id="totalDays" class="w-full p-2 border-t border-b text-center" value="250" min="50" max="500">
                        <button id="increaseDays" class="bg-gray-200 px-4 py-2 rounded-r font-bold text-xl">+</button>
                    </div>
                </div>
            </div>
            <div class="text-sm text-gray-600 mb-4">
                <p>* Giai đoạn chuẩn bị bắt đầu 20 ngày trước ngày khởi công chính thức và không tính vào tổng thời gian thi công.</p>
                <p>* Đợt thanh toán 1 (50%) thực hiện vào ngày bắt đầu thi công chính thức.</p>
                <p>* Khi thay đổi tổng thời gian thi công, thời gian của các hạng mục sẽ thay đổi tỷ lệ tương ứng.</p>
            </div>
            <button id="updateBtn" class="btn-update">Cập nhật</button>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 bg-gray-100 p-2">Biểu đồ Gantt tiến độ thi công</h2>
            <div class="zoom-controls no-print">
                <button id="zoomOut" class="zoom-btn">-</button>
                <button id="zoomReset" class="zoom-btn">Xem toàn bộ</button>
                <button id="zoomIn" class="zoom-btn">+</button>
            </div>
            <div class="flex flex-wrap gap-2 mb-4">
                <div class="payment-milestone"><span class="bg-red-500"></span> Đợt thanh toán</div>
                <div class="payment-milestone"><span class="bg-blue-500"></span> Giai đoạn chuẩn bị</div>
                <div class="payment-milestone"><span class="bg-green-500"></span> Gia cố nền & Móng</div>
                <div class="payment-milestone"><span class="bg-yellow-500"></span> Công trình nhà chính</div>
                <div class="payment-milestone"><span class="bg-purple-500"></span> Công trình phụ</div>
                <div class="payment-milestone"><span class="bg-cyan-500"></span> Sân vườn & Hạ tầng</div>
                <div class="payment-milestone"><span class="bg-pink-500"></span> Hoàn thiện</div>
            </div>
            <div id="chart" class="chart-container"></div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 bg-gray-100 p-2">Bảng chi tiết tiến độ thi công</h2>
            <div class="overflow-auto">
                <table id="taskTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Hạng mục công việc</th>
                            <th>Thời gian bắt đầu</th>
                            <th>Thời gian hoàn thành</th>
                            <th>Số ngày</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody">
                        <!-- Tasks will be added here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 bg-gray-100 p-2">Các đợt thanh toán</h2>
            <div class="overflow-auto">
                <table>
                    <thead>
                        <tr>
                            <th>Đợt</th>
                            <th>Giai đoạn</th>
                            <th>Giá trị (%)</th>
                            <th>Giá trị (VNĐ)</th>
                            <th>Thời gian</th>
                        </tr>
                    </thead>
                    <tbody id="paymentTableBody">
                        <!-- Payments will be added here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="text-right text-sm text-gray-600 mt-10">
            Báo cáo được tạo ngày: <span id="reportDate"></span>
        </div>
    </div>

    <script>
        // Initialize date picker
        flatpickr("#startDate", {
            dateFormat: "d/m/Y",
            locale: "vn",
            defaultDate: "05/05/2025"
        });

        // Project tasks with initial durations
        const initialTasks = [
            { id: 1, name: "GIAI ĐOẠN CHUẨN BỊ", days: 20, category: "preparation", note: "Đợt thanh toán 1: 50%" },
            { id: 1.1, name: "Trắc đạc, định vị công trình", days: 5, category: "preparation", parent: 1, note: "Hạng mục 109" },
            { id: 1.2, name: "Tổ chức công trường, làm lán trại", days: 8, category: "preparation", parent: 1, note: "Điều 3.1" },
            { id: 1.3, name: "Phá dỡ công trình hiện trạng", days: 10, category: "preparation", parent: 1, note: "Hạng mục 131" },
            { id: 1.4, name: "Xây tường rào bảo vệ công trình", days: 10, category: "preparation", parent: 1, note: "Điều 3.3" },

            { id: 2, name: "THI CÔNG GIA CỐ NỀN ĐẤT YẾU & MÓNG", days: 40, category: "foundation", note: "" },
            { id: 2.1, name: "Đào đắp đất tổng thể", days: 15, category: "foundation", parent: 2, note: "Hạng mục 110" },
            { id: 2.2, name: "Ép cọc BTCT 250x250", days: 15, category: "foundation", parent: 2, note: "Hạng mục A" },
            { id: 2.3, name: "Khoan giếng ngầm", days: 5, category: "foundation", parent: 2, note: "Hạng mục 125" },
            { id: 2.4, name: "Đào hố thấm tự nhiên", days: 5, category: "foundation", parent: 2, note: "Hạng mục 127" },

            { id: 3, name: "THI CÔNG PHẦN MÓNG NHÀ TỪ ĐƯỜNG & NÂNG ĐẾ", days: 50, category: "foundation", note: "" },
            { id: 3.1, name: "Thi công phần móng nhà từ đường", days: 30, category: "foundation", parent: 3, note: "Hạng mục 13" },
            { id: 3.2, name: "Thi công nâng cao khối đế lên 0.8m", days: 20, category: "foundation", parent: 3, note: "Hạng mục 14" },

            { id: 4, name: "THI CÔNG MÓNG CÔNG TRÌNH PHỤ", days: 30, category: "foundation", note: "" },
            { id: 4.1, name: "Móng cổng tam quan", days: 10, category: "foundation", parent: 4, note: "Hạng mục 4" },
            { id: 4.2, name: "Móng chòi vọng cảnh", days: 10, category: "foundation", parent: 4, note: "Hạng mục 95" },
            { id: 4.3, name: "Đào hồ Koi và xử lý nền", days: 10, category: "foundation", parent: 4, note: "Hạng mục 100" },

            { id: 5, name: "THI CÔNG TƯỜNG RÀO & NÂNG NỀN", days: 30, category: "main_building", note: "" },
            { id: 5.1, name: "Xây tường bó để nâng nền toàn khối", days: 10, category: "main_building", parent: 5, note: "Hạng mục 1" },
            { id: 5.2, name: "Thi công tường rào thường", days: 15, category: "main_building", parent: 5, note: "Hạng mục 2" },
            { id: 5.3, name: "Thi công tường rào có hoa văn phù điêu", days: 5, category: "main_building", parent: 5, note: "Hạng mục 3" },

            { id: 6, name: "THI CÔNG NHÀ TỪ ĐƯỜNG (NHÀ CHÍNH)", days: 70, category: "main_building", note: "Đợt thanh toán 2: 25%" },
            { id: 6.1, name: "Thi công tầng trệt nhà chính", days: 30, category: "main_building", parent: 6, note: "Hạng mục 15" },
            { id: 6.2, name: "Thi công mái công trình", days: 30, category: "main_building", parent: 6, note: "Hạng mục 16" },
            { id: 6.3, name: "Thi công phù điêu đỉnh, diềm mái", days: 15, category: "main_building", parent: 6, note: "Hạng mục 17" },
            { id: 6.4, name: "Lắp đặt cuốn thư đá", days: 10, category: "main_building", parent: 6, note: "Hạng mục 18" },

            { id: 7, name: "THI CÔNG CỔNG TAM QUAN", days: 40, category: "main_building", note: "" },
            { id: 7.1, name: "Thi công phần thân cổng", days: 15, category: "main_building", parent: 7, note: "Hạng mục 5" },
            { id: 7.2, name: "Thi công phần mái cổng", days: 15, category: "main_building", parent: 7, note: "Hạng mục 6-7" },
            { id: 7.3, name: "Lắp đặt bộ cửa cổng chính và phụ", days: 10, category: "main_building", parent: 7, note: "Hạng mục 8-9" },

            { id: 8, name: "THI CÔNG CÔNG TRÌNH PHỤ", days: 60, category: "ancillary", note: "Đợt thanh toán 3: 10%" },
            { id: 8.1, name: "Thi công thân và mái nhà chòi vọng cảnh", days: 30, category: "ancillary", parent: 8, note: "Hạng mục 96-97" },
            { id: 8.2, name: "Thi công hồ Koi", days: 40, category: "ancillary", parent: 8, note: "Hạng mục 100" },
            { id: 8.3, name: "Thi công khu nghĩa trang", days: 30, category: "ancillary", parent: 8, note: "Hạng mục 103-108" },
            { id: 8.4, name: "Xây nhà kho và bồn nước", days: 20, category: "ancillary", parent: 8, note: "Hạng mục 123" },

            { id: 9, name: "THI CÔNG HẠ TẦNG TỔNG THỂ", days: 30, category: "landscape", note: "" },
            { id: 9.1, name: "Thi công bê tông nền cảnh quan và đường dạo", days: 15, category: "landscape", parent: 9, note: "Hạng mục 111" },
            { id: 9.2, name: "Xây bó vỉa và hoàn thiện nền đá", days: 10, category: "landscape", parent: 9, note: "Hạng mục 112-113-117" },
            { id: 9.3, name: "Lắp đặt hệ thống thoát nước và tưới tự động", days: 15, category: "landscape", parent: 9, note: "Hạng mục 116" },

            { id: 10, name: "HOÀN THIỆN NHÀ TỪ ĐƯỜNG (NHÀ CHÍNH)", days: 60, category: "finishing", note: "Đợt thanh toán 4: 5%" },
            { id: 10.1, name: "Thi công ốp lát gạch", days: 20, category: "finishing", parent: 10, note: "Hạng mục 20-24" },
            { id: 10.2, name: "Thi công ốp đá và lan can", days: 30, category: "finishing", parent: 10, note: "Hạng mục 25-26" },
            { id: 10.3, name: "Lắp đặt hệ thống điện và nước âm tường", days: 20, category: "finishing", parent: 10, note: "Hạng mục 19" },
            { id: 10.4, name: "Lắp đặt cửa gỗ", days: 15, category: "finishing", parent: 10, note: "Hạng mục 31-39" },
            { id: 10.5, name: "Sơn nước trong và ngoài nhà", days: 20, category: "finishing", parent: 10, note: "Hạng mục 28-29-30" },
            { id: 10.6, name: "Lắp đặt thiết bị vệ sinh", days: 10, category: "finishing", parent: 10, note: "Hạng mục 40-44" },
            { id: 10.7, name: "Lắp đặt thiết bị điện và chiếu sáng", days: 15, category: "finishing", parent: 10, note: "Hạng mục 74-93" },
            { id: 10.8, name: "Xử lý phòng chống mối", days: 5, category: "finishing", parent: 10, note: "Hạng mục 129" },

            { id: 11, name: "THI CÔNG NỘI THẤT", days: 30, category: "finishing", note: "Đợt thanh toán 5: 4%" },
            { id: 11.1, name: "Thi công trần trang trí hoa văn", days: 10, category: "finishing", parent: 11, note: "Hạng mục 55" },
            { id: 11.2, name: "Lắp đặt vách ốp tường sau bàn thờ", days: 10, category: "finishing", parent: 11, note: "Hạng mục 49" },
            { id: 11.3, name: "Lắp đặt bàn thờ và nội thất phòng thờ", days: 10, category: "finishing", parent: 11, note: "Hạng mục 50-54" },
            { id: 11.4, name: "Lắp đặt tủ bếp và nội thất phòng bếp", days: 10, category: "finishing", parent: 11, note: "Hạng mục 56-61" },
            { id: 11.5, name: "Lắp đặt nội thất phòng ngủ", days: 10, category: "finishing", parent: 11, note: "Hạng mục 62-72" },

            { id: 12, name: "HOÀN THIỆN CẢNH QUAN", days: 45, category: "landscape", note: "" },
            { id: 12.1, name: "Thi công tiểu cảnh non bộ", days: 15, category: "landscape", parent: 12, note: "Hạng mục 101" },
            { id: 12.2, name: "Thi công cầu vượt hồ koi", days: 10, category: "landscape", parent: 12, note: "Hạng mục 102" },
            { id: 12.3, name: "Trồng thảm cỏ nhung Nhật", days: 10, category: "landscape", parent: 12, note: "Hạng mục 106-115" },
            { id: 12.4, name: "Lắp đặt hệ thống đèn sân vườn", days: 15, category: "landscape", parent: 12, note: "Hạng mục 118-121" },
            { id: 12.5, name: "Hoàn thiện trồng cây tiểu cảnh", days: 10, category: "landscape", parent: 12, note: "Ngoài hợp đồng" },

            { id: 13, name: "HOÀN THIỆN VÀ BÀN GIAO", days: 20, category: "finishing", note: "Đợt thanh toán 6: 3%" },
            { id: 13.1, name: "Hoàn thiện nhà chòi vọng cảnh", days: 5, category: "finishing", parent: 13, note: "Hạng mục 98-99" },
            { id: 13.2, name: "Vệ sinh công nghiệp toàn công trình", days: 10, category: "finishing", parent: 13, note: "Hạng mục 130" },
            { id: 13.3, name: "Nghiệm thu và bàn giao", days: 5, category: "finishing", parent: 13, note: "" },
            { id: 13.4, name: "Bảo hành", days: 365, category: "finishing", parent: 13, note: "Đợt thanh toán 7: 3%" }
        ];

        // Payment milestones
        const payments = [
            { id: 1, phase: "Ký hợp đồng", percentage: 50, value: 6444400000, milestone: "start" },
            { id: 2, phase: "Hoàn thành mái ngói (cất nóc)", percentage: 25, value: 3222200000, milestone: "roof" },
            { id: 3, phase: "Xây tô đạt 80%", percentage: 10, value: 1288880000, milestone: "walls" },
            { id: 4, phase: "Bả bột 2 lớp đạt 80%, hoàn thiện ốp lát", percentage: 5, value: 644440000, milestone: "finishing" },
            { id: 5, phase: "Lắp đặt đồ gỗ nội thất", percentage: 4, value: 515552000, milestone: "furniture" },
            { id: 6, phase: "Nghiệm thu + bàn giao", percentage: 3, value: 386664000, milestone: "handover" },
            { id: 7, phase: "Bảo hành, sau 01 năm", percentage: 3, value: 386664000, milestone: "warranty" }
        ];

        let tasks = [...initialTasks];
        let chart;
        let currentStartDate = new Date(2025, 4, 5); // 05/05/2025
        let currentTotalDays = 250;
        let currentZoomLevel = 1;

        // Helper functions
        function formatDate(date) {
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }

        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            return new Date(parseInt(parts[2]), parseInt(parts[1])-1, parseInt(parts[0]));
        }

        function getTaskColor(category) {
            const colors = {
                'preparation': '#3b82f6', // Blue
                'foundation': '#10b981',  // Green
                'main_building': '#f59e0b', // Yellow
                'ancillary': '#8b5cf6',   // Purple
                'landscape': '#06b6d4',   // Cyan
                'finishing': '#ec4899'    // Pink
            };
            return colors[category] || '#6b7280'; // Default gray
        }

        function calculateTaskDates() {
            // First, calculate the proportional durations
            const originalTotalWorkDays = initialTasks.reduce((total, task) => {
                if (task.parent === undefined && task.id !== 1 && task.id !== 13.4) { // Exclude preparation phase and warranty
                    return total + task.days;
                }
                return total;
            }, 0);

            const ratio = currentTotalDays / originalTotalWorkDays;

            // Reset tasks array with deep copy of initialTasks
            tasks = initialTasks.map(task => ({...task}));

            // Scale the durations based on the ratio (except for preparation phase and warranty)
            tasks.forEach(task => {
                if (task.id !== 1 && task.id !== 13.4 && task.parent !== 1) {
                    task.days = Math.round(task.days * ratio);
                    if (task.days < 1) task.days = 1; // Ensure at least 1 day
                }
            });

            // Preparation phase starts 20 days before the construction
            const prepStart = new Date(currentStartDate);
            prepStart.setDate(prepStart.getDate() - 20);

            // Calculate start and end dates for each task
            let currentDate = new Date(prepStart);
            
            // Sort tasks by parent-child relationship
            const sortedTasks = [];
            
            // First add preparation phase
            const prepTasks = tasks.filter(t => t.id === 1 || t.parent === 1);
            sortedTasks.push(...prepTasks);
            
            // Then add remaining main tasks in order
            for (let i = 2; i <= 13; i++) {
                const mainTask = tasks.find(t => t.id === i);
                if (mainTask) sortedTasks.push(mainTask);
                
                // Add subtasks
                const subTasks = tasks.filter(t => t.parent === i);
                sortedTasks.push(...subTasks);
            }
            
            // Calculate dates for preparation phase
            let prepStartDate = new Date(prepStart);
            for (const task of sortedTasks.filter(t => t.id === 1 || t.parent === 1)) {
                task.startDate = new Date(prepStartDate);
                task.endDate = new Date(prepStartDate);
                task.endDate.setDate(task.endDate.getDate() + task.days - 1);
                
                if (task.parent === 1) {
                    prepStartDate = new Date(task.endDate);
                    prepStartDate.setDate(prepStartDate.getDate() + 1);
                }
            }
            
            // Set project start date
            currentDate = new Date(currentStartDate);
            
            // Calculate dates for construction phase (synchronized with dependencies)
            const mainTaskEndDates = {};
            
            // Process each main task group
            for (let i = 2; i <= 13; i++) {
                const mainTask = sortedTasks.find(t => t.id === i);
                if (!mainTask) continue;
                
                // Set main task start date
                if (i === 2) {
                    // First construction task starts at project start date
                    mainTask.startDate = new Date(currentDate);
                } else {
                    // Other tasks may depend on previous tasks
                    if (i === 5 || i === 6) {
                        // Tasks 5 and 6 depend on task 3
                        mainTask.startDate = new Date(mainTaskEndDates[3] || currentDate);
                    } else if (i === 7) {
                        // Task 7 depends on task 5
                        mainTask.startDate = new Date(mainTaskEndDates[5] || currentDate);
                    } else if (i === 8) {
                        // Task 8 depends on task 7 start
                        const task7 = sortedTasks.find(t => t.id === 7);
                        mainTask.startDate = new Date(task7 ? task7.startDate : currentDate);
                    } else if (i === 9 || i === 10) {
                        // Tasks 9 and 10 depend on task 6
                        mainTask.startDate = new Date(mainTaskEndDates[6] || currentDate);
                    } else if (i === 11) {
                        // Task 11 depends on task 10
                        mainTask.startDate = new Date(mainTaskEndDates[10] || currentDate);
                    } else if (i === 12) {
                        // Task 12 depends on task 9
                        mainTask.startDate = new Date(mainTaskEndDates[9] || currentDate);
                    } else if (i === 13) {
                        // Task 13 depends on tasks 11 and 12
                        const endDate11 = mainTaskEndDates[11] || currentDate;
                        const endDate12 = mainTaskEndDates[12] || currentDate;
                        mainTask.startDate = new Date(Math.max(endDate11.getTime(), endDate12.getTime()));
                    } else {
                        // Default dependency on previous task
                        mainTask.startDate = new Date(mainTaskEndDates[i-1] || currentDate);
                    }
                }
                
                // Calculate main task end date
                mainTask.endDate = new Date(mainTask.startDate);
                mainTask.endDate.setDate(mainTask.endDate.getDate() + mainTask.days - 1);
                
                // Store end date for dependencies
                mainTaskEndDates[i] = new Date(mainTask.endDate);
                
                // Process subtasks
                let subtaskStartDate = new Date(mainTask.startDate);
                const subtasks = sortedTasks.filter(t => t.parent === i);
                
                for (const subtask of subtasks) {
                    subtask.startDate = new Date(subtaskStartDate);
                    subtask.endDate = new Date(subtaskStartDate);
                    subtask.endDate.setDate(subtask.endDate.getDate() + subtask.days - 1);
                    
                    // Some subtasks run in parallel, others in sequence
                    if (
                        (i === 4 && subtask.id !== 4.3) || // All subtasks of task 4 run in parallel except 4.3
                        (i === 10 && ![10.4, 10.6, 10.7, 10.8].includes(subtask.id)) || // Some subtasks of task 10 run in parallel
                        (i === 11 && subtask.id !== 11.5) // All subtasks of task 11 run in parallel except 11.5
                    ) {
                        // This subtask runs in parallel, don't update start date
                    } else {
                        // This subtask runs in sequence, update start date for next subtask
                        subtaskStartDate = new Date(subtask.endDate);
                        subtaskStartDate.setDate(subtaskStartDate.getDate() + 1);
                    }
                }
                
                // Special case for warranty period
                if (i === 13) {
                    const warrantyTask = tasks.find(t => t.id === 13.4);
                    if (warrantyTask) {
                        warrantyTask.startDate = new Date(mainTask.endDate);
                        warrantyTask.endDate = new Date(warrantyTask.startDate);
                        warrantyTask.endDate.setDate(warrantyTask.endDate.getDate() + 365); // 1 year
                    }
                }
            }
            
            // Calculate payment milestones
            calculatePaymentMilestones();
        }

        function calculatePaymentMilestones() {
            // Payment 1: Project start
            payments[0].date = new Date(currentStartDate);
            
            // Payment 2: Roof completion (end of task 6.2)
            const roofTask = tasks.find(t => t.id === 6.2);
            payments[1].date = roofTask ? new Date(roofTask.endDate) : null;
            
            // Payment 3: 80% wall completion (during task 8)
            const wallsTask = tasks.find(t => t.id === 8);
            if (wallsTask) {
                const daysFromStart = Math.floor(wallsTask.days * 0.8);
                payments[2].date = new Date(wallsTask.startDate);
                payments[2].date.setDate(payments[2].date.getDate() + daysFromStart);
            } else {
                payments[2].date = null;
            }
            
            // Payment 4: 80% finishing (during task 10)
            const finishingTask = tasks.find(t => t.id === 10);
            if (finishingTask) {
                const daysFromStart = Math.floor(finishingTask.days * 0.8);
                payments[3].date = new Date(finishingTask.startDate);
                payments[3].date.setDate(payments[3].date.getDate() + daysFromStart);
            } else {
                payments[3].date = null;
            }
            
            // Payment 5: Furniture installation (start of task 11)
            const furnitureTask = tasks.find(t => t.id === 11);
            payments[4].date = furnitureTask ? new Date(furnitureTask.startDate) : null;
            
            // Payment 6: Handover (end of task 13.3)
            const handoverTask = tasks.find(t => t.id === 13.3);
            payments[5].date = handoverTask ? new Date(handoverTask.endDate) : null;
            
            // Payment 7: Warranty (end of warranty period)
            const warrantyTask = tasks.find(t => t.id === 13.4);
            payments[6].date = warrantyTask ? new Date(warrantyTask.endDate) : null;
        }

        function updateChart() {
            calculateTaskDates();
            
            // Prepare series data for chart
            const seriesData = [];
            
            // Add tasks
            tasks.forEach(task => {
                const color = getTaskColor(task.category);
                const isMainTask = task.parent === undefined;
                
                seriesData.push({
                    x: task.name,
                    y: [
                        task.startDate.getTime(),
                        task.endDate.getTime()
                    ],
                    fillColor: color,
                    borderColor: color,
                    z: isMainTask ? 'Chính' : 'Phụ',
                    parent: task.parent
                });
            });
            
            // Add payment milestones
            payments.forEach(payment => {
                if (payment.date) {
                    seriesData.push({
                        x: `Đợt ${payment.id}: ${payment.phase} (${payment.percentage}%)`,
                        y: [
                            payment.date.getTime(),
                            payment.date.getTime() + 86400000 // 1 day in milliseconds
                        ],
                        fillColor: '#ef4444', // Red
                        borderColor: '#ef4444',
                        z: 'Thanh toán'
                    });
                }
            });

            // Sort series data by start date
            seriesData.sort((a, b) => a.y[0] - b.y[0]);
            
            // Get min and max dates for chart
            const minDate = tasks.reduce((min, task) => 
                task.startDate < min ? task.startDate : min, 
                tasks[0].startDate
            );
            
            const maxDate = tasks.reduce((max, task) => 
                task.endDate > max ? task.endDate : max, 
                tasks[0].endDate
            );
            
            // Chart options
            const options = {
                series: [{
                    data: seriesData
                }],
                chart: {
                    height: 850,
                    type: 'rangeBar',
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: true
                    },
                    background: '#ffffff'
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        distributed: true,
                        dataLabels: {
                            hideOverflowingLabels: false
                        },
                        rangeBarOverlap: true,
                        rangeBarGroupRows: true
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val, opts) {
                        const task = tasks.find(t => t.name === opts.w.globals.labels[opts.dataPointIndex]);
                        return task ? `${task.days} ngày` : '';
                    },
                    style: {
                        colors: ['#fff'],
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    custom: function({series, seriesIndex, dataPointIndex, w}) {
                        const data = w.globals.initialSeries[seriesIndex].data[dataPointIndex];
                        
                        // Find the corresponding task or payment
                        const taskName = data.x;
                        const isPayment = taskName.includes('Đợt');
                        
                        let startDate, endDate, duration;
                        
                        if (isPayment) {
                            const paymentId = parseInt(taskName.split(':')[0].replace('Đợt ', ''));
                            const payment = payments.find(p => p.id === paymentId);
                            startDate = payment.date ? formatDate(payment.date) : 'N/A';
                            endDate = startDate;
                            duration = 'Thanh toán';
                        } else {
                            const task = tasks.find(t => t.name === taskName);
                            startDate = formatDate(task.startDate);
                            endDate = formatDate(task.endDate);
                            duration = `${task.days} ngày`;
                        }
                        
                        return `
                            <div class="p-2 bg-white border rounded shadow-lg">
                                <div class="font-bold mb-1">${taskName}</div>
                                <div>
                                    <span class="font-semibold">Bắt đầu:</span> ${startDate}<br>
                                    <span class="font-semibold">Kết thúc:</span> ${endDate}<br>
                                    <span class="font-semibold">Thời gian:</span> ${duration}
                                </div>
                            </div>
                        `;
                    }
                },
                xaxis: {
                    type: 'datetime',
                    min: minDate.getTime(),
                    max: maxDate.getTime()
                },
                yaxis: {
                    labels: {
                        formatter: function(val) {
                            return val;
                        },
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                grid: {
                    row: {
                        colors: ['#f3f4f6', 'transparent'],
                        opacity: 0.5
                    }
                },
                legend: {
                    show: false
                }
            };

            // Destroy existing chart if it exists
            if (chart) {
                chart.destroy();
            }
            
            // Create new chart
            chart = new ApexCharts(document.getElementById('chart'), options);
            chart.render();
            
            // Update task table
            updateTaskTable();
            
            // Update payment table
            updatePaymentTable();
        }

        function updateTaskTable() {
            const tableBody = document.getElementById('taskTableBody');
            tableBody.innerHTML = '';
            
            tasks.forEach(task => {
                const row = document.createElement('tr');
                
                // Format task ID for display
                let displayId = task.id;
                if (Number.isInteger(task.id) && task.parent === undefined) {
                    displayId = task.id;
                } else if (task.parent !== undefined) {
                    displayId = task.id.toString(); // Format with decimals for subtasks
                }
                
                // Apply indentation for subtasks
                const taskNameClass = task.parent ? 'pl-4' : 'font-bold';
                
                row.innerHTML = `
                    <td>${displayId}</td>
                    <td class="${taskNameClass}">${task.name}</td>
                    <td>${formatDate(task.startDate)}</td>
                    <td>${formatDate(task.endDate)}</td>
                    <td>${task.days}</td>
                    <td>${task.note || ''}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updatePaymentTable() {
            const tableBody = document.getElementById('paymentTableBody');
            tableBody.innerHTML = '';
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                
                const formattedValue = payment.value.toLocaleString('vi-VN') + ' VNĐ';
                const formattedDate = payment.date ? formatDate(payment.date) : 'Theo tiến độ';
                
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${payment.phase}</td>
                    <td>${payment.percentage}%</td>
                    <td>${formattedValue}</td>
                    <td>${formattedDate}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Event handlers
        document.getElementById('updateBtn').addEventListener('click', function() {
            const startDateValue = document.getElementById('startDate').value;
            const totalDaysValue = parseInt(document.getElementById('totalDays').value);
            
            if (isNaN(totalDaysValue) || totalDaysValue < 50 || totalDaysValue > 500) {
                alert('Tổng thời gian thi công phải từ 50 đến 500 ngày.');
                return;
            }
            
            currentStartDate = parseDate(startDateValue);
            currentTotalDays = totalDaysValue;
            
            updateChart();
        });

        document.getElementById('decreaseDays').addEventListener('click', function() {
            const totalDaysInput = document.getElementById('totalDays');
            let value = parseInt(totalDaysInput.value);
            if (value > 50) {
                totalDaysInput.value = value - 10;
            }
        });

        document.getElementById('increaseDays').addEventListener('click', function() {
            const totalDaysInput = document.getElementById('totalDays');
            let value = parseInt(totalDaysInput.value);
            if (value < 500) {
                totalDaysInput.value = value + 10;
            }
        });

        document.getElementById('zoomIn').addEventListener('click', function() {
            currentZoomLevel *= 1.2;
            chart.zoomX(
                chart.w.globals.minX * 0.9,
                chart.w.globals.maxX * 1.1
            );
        });

        document.getElementById('zoomOut').addEventListener('click', function() {
            currentZoomLevel /= 1.2;
            chart.zoomX(
                chart.w.globals.minX * 0.6,
                chart.w.globals.maxX * 1.4
            );
        });

        document.getElementById('zoomReset').addEventListener('click', function() {
            currentZoomLevel = 1;
            chart.resetSeries();
        });

        // Set the report date
        document.getElementById('reportDate').textContent = formatDate(new Date());

        // Initialize the chart
        document.addEventListener('DOMContentLoaded', function() {
            updateChart();
        });
    </script>
</body>
</html>
