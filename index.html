<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Tiến Độ Thi Công - Dự Án Trang Viên Dầu Tiếng</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
            position: relative;
        }
        .gantt-row {
            height: 30px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ddd;
            position: relative;
        }
        .gantt-header {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .gantt-task {
            position: absolute;
            height: 20px;
            border-radius: 3px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 1;
        }
        .gantt-scale {
            position: relative;
            height: 30px;
        }
        .gantt-scale-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #ddd;
        }
        .gantt-scale-text {
            position: absolute;
            font-size: 12px;
            top: 5px;
        }
        .gantt-milestone {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 16px solid red;
            z-index: 2;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        .task-type-1 { background-color: #3498db; } /* Giải phóng mặt bằng */
        .task-type-2 { background-color: #2ecc71; } /* Gia cố nền & Móng */
        .task-type-3 { background-color: #e67e22; } /* Công trình nhà chính */
        .task-type-4 { background-color: #9b59b6; } /* Công trình phụ */
        .task-type-5 { background-color: #1abc9c; } /* Sân vườn & Hạ tầng */
        .task-type-6 { background-color: #e74c3c; } /* Hoàn thiện */
        
        input[type="date"], input[type="number"], input[type="text"] {
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .zoom-controls {
            margin: 10px 0;
        }
        .zoom-controls button {
            font-size: 18px;
            width: 40px;
            height: 40px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        table th {
            background-color: #f2f2f2;
        }
        .payment-row {
            background-color: #f9f9f9;
        }
        .format-number {
            text-align: right;
        }
        @media print {
            body {
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none;
            }
            .gantt-container {
                overflow: visible;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-full mx-auto">
        <h1 class="text-3xl font-bold text-center my-4">BẢNG TIẾN ĐỘ THI CÔNG DỰ ÁN TRANG VIÊN - DẦU TIẾNG</h1>
        
        <div class="bg-white p-4 rounded shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">Thông tin dự án</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <p><strong>Chủ đầu tư:</strong> ANH HƯNG</p>
                </div>
                <div>
                    <p><strong>Địa điểm:</strong> DẦU TIẾNG</p>
                </div>
                <div>
                    <p><strong>Đơn vị thi công:</strong> CÔNG TY TNHH NÉT VIỆT</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 no-print">
                <div>
                    <label class="block mb-2">Giá trị hợp đồng (VNĐ):</label>
                    <input type="text" id="contractValue" value="16,325,800,000" class="w-full">
                </div>
                <div>
                    <label class="block mb-2">Ngày bắt đầu thi công chính thức:</label>
                    <input type="date" id="startDate" value="2025-05-05" class="w-full">
                </div>
                <div>
                    <label class="block mb-2">Tổng thời gian thi công (ngày):</label>
                    <input type="number" id="totalDuration" value="250" min="1" class="w-full">
                </div>
            </div>
            
            <div class="mt-4 no-print">
                <button id="updateButton" class="bg-blue-500 hover:bg-blue-700 text-white py-2 px-4 rounded">
                    Cập nhật tiến độ
                </button>
            </div>
            
            <div class="mt-4" id="projectInfo">
                <p><strong>Giai đoạn chuẩn bị:</strong> Bắt đầu 20 ngày trước ngày khởi công chính thức</p>
                <p><strong>Đợt thanh toán 1 (50%):</strong> Vào ngày bắt đầu thi công chính thức</p>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">Bảng đợt thanh toán</h2>
            <div class="table-container">
                <table id="paymentTable">
                    <thead>
                        <tr>
                            <th>Đợt</th>
                            <th>Giai đoạn thanh toán</th>
                            <th>Tỷ lệ (%)</th>
                            <th>Giá trị (VNĐ)</th>
                            <th>Thời gian</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">Biểu đồ Gantt tiến độ thi công</h2>
            
            <div class="zoom-controls no-print">
                <button id="zoomIn" title="Phóng to"><i class="fas fa-plus"></i></button>
                <button id="zoomOut" title="Thu nhỏ"><i class="fas fa-minus"></i></button>
                <button id="zoomReset" title="Khung nhìn đầy đủ"><i class="fas fa-expand"></i></button>
            </div>
            
            <div class="gantt-container" id="ganttChart">
                <!-- Biểu đồ Gantt sẽ được tạo bằng JavaScript -->
            </div>
            
            <div class="mt-4">
                <h3 class="font-bold">Chú thích màu sắc:</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 mt-2">
                    <div class="flex items-center">
                        <div class="w-4 h-4 mr-2 task-type-1"></div>
                        <span>Giải phóng mặt bằng</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 mr-2 task-type-2"></div>
                        <span>Gia cố nền &amp; Móng</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 mr-2 task-type-3"></div>
                        <span>Công trình nhà chính</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 mr-2 task-type-4"></div>
                        <span>Công trình phụ</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 mr-2 task-type-5"></div>
                        <span>Sân vườn &amp; Hạ tầng</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 mr-2 task-type-6"></div>
                        <span>Hoàn thiện</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded shadow-md">
            <h2 class="text-xl font-bold mb-4">Bảng chi tiết tiến độ thi công</h2>
            <div class="table-container">
                <table id="taskTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Hạng mục công việc</th>
                            <th>Loại công việc</th>
                            <th>Thời gian bắt đầu</th>
                            <th>Thời gian hoàn thành</th>
                            <th>Số ngày</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-600">
            <p>Báo cáo được tạo ngày: <span id="reportDate"></span></p>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Định nghĩa dữ liệu các hạng mục công việc
        const taskData = [
            {id: 1, name: "GIAI ĐOẠN CHUẨN BỊ", type: 1, duration: 20, dependsOn: null, note: "Trước khi thi công chính thức", percentage: 0},
            {id: 2, name: "Trắc đạc, định vị công trình", type: 1, duration: 5, dependsOn: 1, note: "Hạng mục 109", percentage: 0},
            {id: 3, name: "Tổ chức công trường, làm lán trại", type: 1, duration: 8, dependsOn: 1, note: "Điều 3.1", percentage: 0},
            {id: 4, name: "Phá dỡ công trình hiện trạng", type: 1, duration: 10, dependsOn: 2, note: "Hạng mục 131", percentage: 0},
            {id: 5, name: "Xây tường rào bảo vệ công trình", type: 1, duration: 10, dependsOn: 4, note: "Điều 3.3", percentage: 0},
            
            {id: 6, name: "THI CÔNG GIA CỐ NỀN ĐẤT YẾU & MÓNG", type: 2, duration: 40, dependsOn: 1, note: "", percentage: 0},
            {id: 7, name: "Đào đắp đất tổng thể", type: 2, duration: 15, dependsOn: 6, note: "Hạng mục 110", percentage: 0},
            {id: 8, name: "Ép cọc BTCT 250x250", type: 2, duration: 15, dependsOn: 7, note: "Hạng mục A", percentage: 0},
            {id: 9, name: "Khoan giếng ngầm", type: 2, duration: 5, dependsOn: 8, note: "Hạng mục 125", percentage: 0},
            {id: 10, name: "Đào hố thấm tự nhiên", type: 2, duration: 5, dependsOn: 9, note: "Hạng mục 127", percentage: 0},
            
            {id: 11, name: "THI CÔNG PHẦN MÓNG NHÀ TỪ ĐƯỜNG & NÂNG ĐẾ", type: 2, duration: 50, dependsOn: 10, note: "", percentage: 0},
            {id: 12, name: "Thi công phần móng nhà từ đường", type: 2, duration: 30, dependsOn: 11, note: "Hạng mục 13", percentage: 0},
            {id: 13, name: "Thi công nâng cao khối đế lên 0.8m", type: 2, duration: 20, dependsOn: 12, note: "Hạng mục 14", percentage: 0},
            
            {id: 14, name: "THI CÔNG MÓNG CÔNG TRÌNH PHỤ", type: 4, duration: 30, dependsOn: 10, note: "", percentage: 0},
            {id: 15, name: "Móng cổng tam quan", type: 4, duration: 10, dependsOn: 14, note: "Hạng mục 4", percentage: 0},
            {id: 16, name: "Móng chòi vọng cảnh", type: 4, duration: 10, dependsOn: 15, note: "Hạng mục 95", percentage: 0},
            {id: 17, name: "Đào hồ Koi và xử lý nền", type: 4, duration: 10, dependsOn: 16, note: "Hạng mục 100", percentage: 0},
            
            {id: 18, name: "THI CÔNG TƯỜNG RÀO & NÂNG NỀN", type: 2, duration: 30, dependsOn: 13, note: "", percentage: 0},
            {id: 19, name: "Xây tường bó để nâng nền toàn khối", type: 2, duration: 10, dependsOn: 18, note: "Hạng mục 1", percentage: 0},
            {id: 20, name: "Thi công tường rào thường", type: 2, duration: 15, dependsOn: 19, note: "Hạng mục 2", percentage: 0},
            {id: 21, name: "Thi công tường rào có hoa văn phù điêu", type: 2, duration: 5, dependsOn: 20, note: "Hạng mục 3", percentage: 0},
            
            {id: 22, name: "THI CÔNG NHÀ TỪ ĐƯỜNG (NHÀ CHÍNH)", type: 3, duration: 70, dependsOn: 13, note: "Đợt thanh toán 2: 25%", percentage: 25},
            {id: 23, name: "Thi công tầng trệt nhà chính", type: 3, duration: 30, dependsOn: 22, note: "Hạng mục 15", percentage: 0},
            {id: 24, name: "Thi công mái công trình", type: 3, duration: 30, dependsOn: 23, note: "Hạng mục 16", percentage: 0},
            {id: 25, name: "Thi công phù điêu đỉnh, diềm mái", type: 3, duration: 15, dependsOn: 24, note: "Hạng mục 17", percentage: 0},
            {id: 26, name: "Lắp đặt cuốn thư đá", type: 3, duration: 10, dependsOn: 24, note: "Hạng mục 18", percentage: 0},
            
            {id: 27, name: "THI CÔNG CỔNG TAM QUAN", type: 4, duration: 40, dependsOn: 21, note: "", percentage: 0},
            {id: 28, name: "Thi công phần thân cổng", type: 4, duration: 15, dependsOn: 27, note: "Hạng mục 5", percentage: 0},
            {id: 29, name: "Thi công phần mái cổng", type: 4, duration: 15, dependsOn: 28, note: "Hạng mục 6-7", percentage: 0},
            {id: 30, name: "Lắp đặt bộ cửa cổng chính và phụ", type: 4, duration: 10, dependsOn: 29, note: "Hạng mục 8-9", percentage: 0},
            
            {id: 31, name: "THI CÔNG CÔNG TRÌNH PHỤ", type: 4, duration: 60, dependsOn: 21, note: "Đợt thanh toán 3: 10%", percentage: 10},
            {id: 32, name: "Thi công thân và mái nhà chòi vọng cảnh", type: 4, duration: 30, dependsOn: 31, note: "Hạng mục 96-97", percentage: 0},
            {id: 33, name: "Thi công hồ Koi", type: 4, duration: 40, dependsOn: 31, note: "Hạng mục 100", percentage: 0},
            {id: 34, name: "Thi công khu nghĩa trang", type: 4, duration: 30, dependsOn: 31, note: "Hạng mục 103-108", percentage: 0},
            {id: 35, name: "Xây nhà kho và bồn nước", type: 4, duration: 20, dependsOn: 33, note: "Hạng mục 123", percentage: 0},
            
            {id: 36, name: "THI CÔNG HẠ TẦNG TỔNG THỂ", type: 5, duration: 30, dependsOn: 26, note: "", percentage: 0},
            {id: 37, name: "Thi công bê tông nền cảnh quan và đường dạo", type: 5, duration: 15, dependsOn: 36, note: "Hạng mục 111", percentage: 0},
            {id: 38, name: "Xây bó vỉa và hoàn thiện nền đá", type: 5, duration: 10, dependsOn: 37, note: "Hạng mục 112-113-117", percentage: 0},
            {id: 39, name: "Lắp đặt hệ thống thoát nước và tưới tự động", type: 5, duration: 15, dependsOn: 37, note: "Hạng mục 116", percentage: 0},
            
            {id: 40, name: "HOÀN THIỆN NHÀ TỪ ĐƯỜNG (NHÀ CHÍNH)", type: 6, duration: 60, dependsOn: 26, note: "Đợt thanh toán 4: 5%", percentage: 5},
            {id: 41, name: "Thi công ốp lát gạch", type: 6, duration: 20, dependsOn: 40, note: "Hạng mục 20-24", percentage: 0},
            {id: 42, name: "Thi công ốp đá và lan can", type: 6, duration: 30, dependsOn: 40, note: "Hạng mục 25-26", percentage: 0},
            {id: 43, name: "Lắp đặt hệ thống điện và nước âm tường", type: 6, duration: 20, dependsOn: 40, note: "Hạng mục 19", percentage: 0},
            {id: 44, name: "Lắp đặt cửa gỗ", type: 6, duration: 15, dependsOn: 41, note: "Hạng mục 31-39", percentage: 0},
            {id: 45, name: "Sơn nước trong và ngoài nhà", type: 6, duration: 20, dependsOn: 41, note: "Hạng mục 28-29-30", percentage: 0},
            {id: 46, name: "Lắp đặt thiết bị vệ sinh", type: 6, duration: 10, dependsOn: 44, note: "Hạng mục 40-44", percentage: 0},
            {id: 47, name: "Lắp đặt thiết bị điện và chiếu sáng", type: 6, duration: 15, dependsOn: 44, note: "Hạng mục 74-93", percentage: 0},
            {id: 48, name: "Xử lý phòng chống mối", type: 6, duration: 5, dependsOn: 46, note: "Hạng mục 129", percentage: 0},
            
            {id: 49, name: "THI CÔNG NỘI THẤT", type: 6, duration: 30, dependsOn: 48, note: "Đợt thanh toán 5: 4%", percentage: 4},
            {id: 50, name: "Thi công trần trang trí hoa văn", type: 6, duration: 10, dependsOn: 49, note: "Hạng mục 55", percentage: 0},
            {id: 51, name: "Lắp đặt vách ốp tường sau bàn thờ", type: 6, duration: 10, dependsOn: 49, note: "Hạng mục 49", percentage: 0},
            {id: 52, name: "Lắp đặt bàn thờ và nội thất phòng thờ", type: 6, duration: 10, dependsOn: 50, note: "Hạng mục 50-54", percentage: 0},
            {id: 53, name: "Lắp đặt tủ bếp và nội thất phòng bếp", type: 6, duration: 10, dependsOn: 50, note: "Hạng mục 56-61", percentage: 0},
            {id: 54, name: "Lắp đặt nội thất phòng ngủ", type: 6, duration: 10, dependsOn: 52, note: "Hạng mục 62-72", percentage: 0},
            
            {id: 55, name: "HOÀN THIỆN CẢNH QUAN", type: 5, duration: 45, dependsOn: 39, note: "", percentage: 0},
            {id: 56, name: "Thi công tiểu cảnh non bộ", type: 5, duration: 15, dependsOn: 55, note: "Hạng mục 101", percentage: 0},
            {id: 57, name: "Thi công cầu vượt hồ koi", type: 5, duration: 10, dependsOn: 56, note: "Hạng mục 102", percentage: 0},
            {id: 58, name: "Trồng thảm cỏ nhung Nhật", type: 5, duration: 10, dependsOn: 57, note: "Hạng mục 106-115", percentage: 0},
            {id: 59, name: "Lắp đặt hệ thống đèn sân vườn", type: 5, duration: 15, dependsOn: 57, note: "Hạng mục 118-121", percentage: 0},
            {id: 60, name: "Hoàn thiện trồng cây tiểu cảnh", type: 5, duration: 10, dependsOn: 58, note: "Ngoài hợp đồng", percentage: 0},
            
            {id: 61, name: "HOÀN THIỆN VÀ BÀN GIAO", type: 6, duration: 20, dependsOn: 54, note: "Đợt thanh toán 6: 3%", percentage: 3},
            {id: 62, name: "Hoàn thiện nhà chòi vọng cảnh", type: 6, duration: 5, dependsOn: 61, note: "Hạng mục 98-99", percentage: 0},
            {id: 63, name: "Vệ sinh công nghiệp toàn công trình", type: 6, duration: 10, dependsOn: 62, note: "Hạng mục 130", percentage: 0},
            {id: 64, name: "Nghiệm thu và bàn giao", type: 6, duration: 5, dependsOn: 63, note: "", percentage: 0},
            {id: 65, name: "Bảo hành", type: 6, duration: 365, dependsOn: 64, note: "Đợt thanh toán 7: 3%", percentage: 3}
        ];
        
        // Định nghĩa dữ liệu các đợt thanh toán
        const paymentData = [
            {id: 1, name: "Ký hợp đồng", percentage: 50, milestone: true, taskId: 6},
            {id: 2, name: "Hoàn thành mái ngói (cất nóc nhà thờ chính, cổng tam quan)", percentage: 25, milestone: true, taskId: 22},
            {id: 3, name: "Xây tô đạt 80%", percentage: 10, milestone: true, taskId: 31},
            {id: 4, name: "Bả bột 2 lớp đạt 80%, hoàn thiện ốp lát", percentage: 5, milestone: true, taskId: 40},
            {id: 5, name: "Lắp đặt đồ gỗ nội thất", percentage: 4, milestone: true, taskId: 49},
            {id: 6, name: "Nghiệm thu + bàn giao", percentage: 3, milestone: true, taskId: 61},
            {id: 7, name: "Bảo hành, sau 01 năm", percentage: 3, milestone: true, taskId: 65}
        ];
        
        // Khởi tạo các biến
        let contractValue = 12888800000;
        let startDate = new Date("2025-05-05");
        let totalDuration = 250;
        let dayWidth = 2; // Độ rộng mặc định cho mỗi ngày trên biểu đồ Gantt
        let ganttWidth = totalDuration * dayWidth;
        let tasks = [];
        let currentScale = 1;
        
        // Hàm định dạng số
        function formatNumber(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }
        
        // Hàm định dạng ngày
        function formatDate(date) {
            return new Date(date).toLocaleDateString('vi-VN');
        }
        
        // Hàm tính ngày kết thúc dựa trên ngày bắt đầu và số ngày
        function calculateEndDate(startDate, days) {
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + days - 1);
            return endDate;
        }
        
        // Hàm tạo lại danh sách các công việc với thời gian được cập nhật
        function recreateTasks() {
            tasks = [];
            
            // Giai đoạn chuẩn bị bắt đầu 20 ngày trước ngày khởi công chính thức
            const prepStartDate = new Date(startDate);
            prepStartDate.setDate(prepStartDate.getDate() - 20);
            
            // Tạo lại các công việc với thời lượng được điều chỉnh theo tỷ lệ
            for (let i = 0; i < taskData.length; i++) {
                const taskInfo = taskData[i];
                const task = { ...taskInfo };
                
                // Điều chỉnh thời lượng theo tỷ lệ với tổng thời gian
                if (task.id > 5) { // Các công việc thi công chính thức (không phải giai đoạn chuẩn bị)
                    task.duration = Math.round(task.duration * totalDuration / 250);
                }
                
                // Tính ngày bắt đầu và kết thúc
                if (task.id === 1) { // Giai đoạn chuẩn bị
                    task.start = new Date(prepStartDate);
                    task.end = calculateEndDate(task.start, task.duration);
                } else if (task.id === 6) { // Bắt đầu thi công chính thức
                    task.start = new Date(startDate);
                    task.end = calculateEndDate(task.start, task.duration);
                } else {
                    const dependsOnTask = tasks.find(t => t.id === task.dependsOn);
                    if (dependsOnTask) {
                        if (task.id === 2 || task.id === 3) { // Các công việc chuẩn bị đầu tiên
                            task.start = new Date(dependsOnTask.start);
                        } else {
                            // Các công việc khác bắt đầu sau khi công việc trước kết thúc
                            task.start = new Date(dependsOnTask.end);
                            task.start.setDate(task.start.getDate() + 1);
                        }
                        task.end = calculateEndDate(task.start, task.duration);
                    }
                }
                
                tasks.push(task);
            }
        }
        
        // Hàm vẽ biểu đồ Gantt
        function drawGantt() {
            const ganttContainer = document.getElementById("ganttChart");
            ganttContainer.innerHTML = "";
            ganttContainer.style.width = `${ganttWidth + 50}px`;
            
            // Tìm ngày bắt đầu và kết thúc của toàn bộ dự án
            const projectStart = tasks.reduce((min, task) => task.start < min ? task.start : min, tasks[0].start);
            const projectEnd = tasks.reduce((max, task) => task.end > max ? task.end : max, tasks[0].end);
            
            const projectDuration = (projectEnd - projectStart) / (1000 * 60 * 60 * 24) + 1;
            
            // Tạo thang đo thời gian
            const scaleEl = document.createElement("div");
            scaleEl.className = "gantt-scale";
            
            // Tạo các marker cho mỗi tháng
            let currentDate = new Date(projectStart);
            currentDate.setDate(1); // Bắt đầu từ ngày 1 của tháng
            
            while (currentDate <= projectEnd) {
                const days = (currentDate - projectStart) / (1000 * 60 * 60 * 24);
                const left = days * dayWidth;
                
                const markerEl = document.createElement("div");
                markerEl.className = "gantt-scale-marker";
                markerEl.style.left = `${left}px`;
                
                const textEl = document.createElement("div");
                textEl.className = "gantt-scale-text";
                textEl.style.left = `${left + 5}px`;
                textEl.textContent = `${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`;
                
                scaleEl.appendChild(markerEl);
                scaleEl.appendChild(textEl);
                
                // Tăng lên 1 tháng
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            ganttContainer.appendChild(scaleEl);
            
            // Tạo các hàng cho biểu đồ Gantt
            for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];
                
                const rowEl = document.createElement("div");
                rowEl.className = "gantt-row";
                
                // Tính vị trí của công việc trên biểu đồ
                const days = (task.start - projectStart) / (1000 * 60 * 60 * 24);
                const left = days * dayWidth;
                const width = task.duration * dayWidth;
                
                // Tạo thanh công việc
                if (task.id !== 65) { // Không vẽ thanh cho công việc bảo hành (quá dài)
                    const taskEl = document.createElement("div");
                    taskEl.className = `gantt-task task-type-${task.type}`;
                    taskEl.style.left = `${left}px`;
                    taskEl.style.width = `${width}px`;
                    taskEl.setAttribute("data-id", task.id);
                    taskEl.setAttribute("data-name", task.name);
                    taskEl.setAttribute("data-start", formatDate(task.start));
                    taskEl.setAttribute("data-end", formatDate(task.end));
                    taskEl.setAttribute("data-duration", task.duration);
                    
                    // Thêm tooltip khi hover
                    taskEl.addEventListener("mouseover", function(e) {
                        const tooltip = document.getElementById("tooltip");
                        tooltip.innerHTML = `
                            <strong>${task.name}</strong><br>
                            Bắt đầu: ${formatDate(task.start)}<br>
                            Kết thúc: ${formatDate(task.end)}<br>
                            Thời gian: ${task.duration} ngày<br>
                            ${task.note ? `Ghi chú: ${task.note}` : ''}
                        `;
                        tooltip.style.display = "block";
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    });
                    
                    taskEl.addEventListener("mouseout", function() {
                        document.getElementById("tooltip").style.display = "none";
                    });
                    
                    rowEl.appendChild(taskEl);
                }
                
                // Thêm các mốc thanh toán
                const payment = paymentData.find(p => p.taskId === task.id);
                if (payment) {
                    const milestoneEl = document.createElement("div");
                    milestoneEl.className = "gantt-milestone";
                    milestoneEl.style.left = `${left}px`;
                    milestoneEl.style.top = "7px";
                    milestoneEl.setAttribute("data-payment", payment.id);
                    milestoneEl.setAttribute("data-name", payment.name);
                    milestoneEl.setAttribute("data-percentage", payment.percentage);
                    
                    // Thêm tooltip khi hover
                    milestoneEl.addEventListener("mouseover", function(e) {
                        const tooltip = document.getElementById("tooltip");
                        tooltip.innerHTML = `
                            <strong>Đợt thanh toán ${payment.id}: ${payment.name}</strong><br>
                            Giá trị: ${payment.percentage}% (${formatNumber(contractValue * payment.percentage / 100)} VNĐ)<br>
                            Ngày: ${formatDate(task.start)}
                        `;
                        tooltip.style.display = "block";
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    });
                    
                    milestoneEl.addEventListener("mouseout", function() {
                        document.getElementById("tooltip").style.display = "none";
                    });
                    
                    rowEl.appendChild(milestoneEl);
                }
                
                ganttContainer.appendChild(rowEl);
            }
        }
        
        // Hàm cập nhật bảng công việc
        function updateTaskTable() {
            const tbody = document.querySelector("#taskTable tbody");
            tbody.innerHTML = "";
            
            for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];
                
                const tr = document.createElement("tr");
                
                // STT
                const tdId = document.createElement("td");
                tdId.textContent = task.id;
                tr.appendChild(tdId);
                
                // Hạng mục công việc
                const tdName = document.createElement("td");
                tdName.textContent = task.name;
                // Định dạng đậm cho các hạng mục chính
                if (task.id === 1 || task.id === 6 || task.id === 11 || task.id === 14 || 
                    task.id === 18 || task.id === 22 || task.id === 27 || task.id === 31 || 
                    task.id === 36 || task.id === 40 || task.id === 49 || task.id === 55 || 
                    task.id === 61) {
                    tdName.style.fontWeight = "bold";
                }
                tr.appendChild(tdName);
                
                // Loại công việc
                const tdType = document.createElement("td");
                const types = ["", "Giải phóng mặt bằng", "Gia cố nền & Móng", "Công trình nhà chính", 
                            "Công trình phụ", "Sân vườn & Hạ tầng", "Hoàn thiện"];
                tdType.textContent = types[task.type];
                tr.appendChild(tdType);
                
                // Thời gian bắt đầu
                const tdStart = document.createElement("td");
                tdStart.textContent = formatDate(task.start);
                tr.appendChild(tdStart);
                
                // Thời gian hoàn thành
                const tdEnd = document.createElement("td");
                tdEnd.textContent = formatDate(task.end);
                tr.appendChild(tdEnd);
                
                // Số ngày
                const tdDuration = document.createElement("td");
                tdDuration.textContent = task.duration;
                tr.appendChild(tdDuration);
                
                // Ghi chú
                const tdNote = document.createElement("td");
                if (task.percentage > 0) {
                    tdNote.innerHTML = `<strong>Đợt thanh toán ${paymentData.find(p => p.taskId === task.id).id}: ${task.percentage}%</strong>`;
                    if (task.note) {
                        tdNote.innerHTML += `<br>${task.note}`;
                    }
                } else {
                    tdNote.textContent = task.note;
                }
                tr.appendChild(tdNote);
                
                tbody.appendChild(tr);
            }
        }
        
        // Hàm cập nhật bảng đợt thanh toán
        function updatePaymentTable() {
            const tbody = document.querySelector("#paymentTable tbody");
            tbody.innerHTML = "";
            
            for (let i = 0; i < paymentData.length; i++) {
                const payment = paymentData[i];
                const task = tasks.find(t => t.id === payment.taskId);
                
                const tr = document.createElement("tr");
                tr.className = "payment-row";
                
                // Đợt
                const tdId = document.createElement("td");
                tdId.textContent = payment.id;
                tr.appendChild(tdId);
                
                // Giai đoạn thanh toán
                const tdName = document.createElement("td");
                tdName.textContent = payment.name;
                tr.appendChild(tdName);
                
                // Tỷ lệ
                const tdPercentage = document.createElement("td");
                tdPercentage.textContent = `${payment.percentage}%`;
                tr.appendChild(tdPercentage);
                
                // Giá trị
                const tdValue = document.createElement("td");
                tdValue.textContent = formatNumber(contractValue * payment.percentage / 100);
                tdValue.className = "format-number";
                tr.appendChild(tdValue);
                
                // Thời gian
                const tdTime = document.createElement("td");
                tdTime.textContent = task ? formatDate(task.start) : "-";
                tr.appendChild(tdTime);
                
                tbody.appendChild(tr);
            }
        }
        
        // Hàm cập nhật toàn bộ giao diện
        function updateUI() {
            // Xử lý giá trị hợp đồng
            const contractValueInput = document.getElementById("contractValue").value;
            contractValue = Number(contractValueInput.replace(/[^0-9]/g, ""));
            document.getElementById("contractValue").value = formatNumber(contractValue);
            
            // Xử lý ngày bắt đầu
            const startDateInput = document.getElementById("startDate").value;
            startDate = new Date(startDateInput);
            
            // Xử lý tổng thời gian thi công
            totalDuration = Number(document.getElementById("totalDuration").value) || 250;
            
            // Tạo lại danh sách công việc
            recreateTasks();
            
            // Vẽ lại biểu đồ Gantt
            drawGantt();
            
            // Cập nhật bảng công việc
            updateTaskTable();
            
            // Cập nhật bảng đợt thanh toán
            updatePaymentTable();
            
            // Cập nhật ngày tạo báo cáo
            document.getElementById("reportDate").textContent = formatDate(new Date());
        }
        
        // Khởi tạo giao diện
        document.addEventListener("DOMContentLoaded", function() {
            // Thiết lập ngày hiện tại cho input date
            document.getElementById("startDate").value = "2025-05-05";
            
            // Cập nhật giao diện
            updateUI();
            
            // Xử lý sự kiện nhấn nút cập nhật
            document.getElementById("updateButton").addEventListener("click", function() {
                updateUI();
            });
            
            // Xử lý sự kiện phóng to biểu đồ
            document.getElementById("zoomIn").addEventListener("click", function() {
                if (currentScale < 3) {
                    currentScale += 0.25;
                    dayWidth = 2 * currentScale;
                    ganttWidth = (tasks[tasks.length - 1].end - tasks[0].start) / (1000 * 60 * 60 * 24) * dayWidth;
                    drawGantt();
                }
            });
            
            // Xử lý sự kiện thu nhỏ biểu đồ
            document.getElementById("zoomOut").addEventListener("click", function() {
                if (currentScale > 0.5) {
                    currentScale -= 0.25;
                    dayWidth = 2 * currentScale;
                    ganttWidth = (tasks[tasks.length - 1].end - tasks[0].start) / (1000 * 60 * 60 * 24) * dayWidth;
                    drawGantt();
                }
            });
            
            // Xử lý sự kiện đặt lại kích thước biểu đồ
            document.getElementById("zoomReset").addEventListener("click", function() {
                currentScale = 1;
                dayWidth = 2;
                ganttWidth = (tasks[tasks.length - 1].end - tasks[0].start) / (1000 * 60 * 60 * 24) * dayWidth;
                drawGantt();
            });
            
            // Xử lý định dạng số cho input giá trị hợp đồng
            document.getElementById("contractValue").addEventListener("blur", function() {
                const value = this.value.replace(/[^0-9]/g, "");
                this.value = formatNumber(value);
            });
        });
    </script>
</body>
</html>
